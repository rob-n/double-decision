<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>Double Decision</title>
  <style>
    :root {
      --bg: #0f172a;
      --fg: #e5e7eb;
      --muted: #94a3b8;
      --card: #111827;
      --accent: #22c55e;
      --accent2: #3b82f6;
      --bad: #ef4444;
      --ring: #334155;
      --btn: #1f2937;
    }
    body.high-contrast {
      --bg: #000;
      --fg: #fff;
      --muted: #d1d5db;
      --card: #000;
      --accent: #00ff66;
      --accent2: #00b7ff;
      --bad: #ff4d4d;
      --ring: #fff;
      --btn: #111;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { margin: 0; background: var(--bg); color: var(--fg); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    body { min-height: 100vh; touch-action: manipulation; }
    body.trial-active { overflow: hidden; }
    .app { max-width: 760px; margin: 0 auto; padding: 12px 12px 24px; }
    .topbar { display: grid; gap: 8px; grid-template-columns: 1fr 1fr; margin-bottom: 8px; }
    .pill { background: var(--card); border: 1px solid var(--ring); border-radius: 12px; padding: 8px 10px; font-size: 14px; }
    .controls { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
    button { border: 1px solid var(--ring); color: var(--fg); background: var(--btn); border-radius: 12px; padding: 12px 14px; font-size: 16px; font-weight: 650; min-height: 48px; }
    button:active { transform: scale(0.98); }
    button.primary { background: var(--accent2); color: #fff; border-color: transparent; }
    button.good { background: var(--accent); color: #08130c; border-color: transparent; }
    button.warn { background: #f59e0b; color: #1f1300; border-color: transparent; }
    .hint { color: var(--muted); font-size: 13px; margin: 0 0 8px; }
    .card { background: var(--card); border: 1px solid var(--ring); border-radius: 16px; padding: 12px; }
    #stimulusWrap { aspect-ratio: 1 / 1; width: 100%; max-height: 56vh; margin: 0 auto; }
    #stimulusCanvas { width: 100%; height: 100%; border-radius: 12px; background: #020617; border: 1px solid var(--ring); }
    .hidden { display: none !important; }
    .response { margin-top: 10px; display: grid; gap: 10px; }
    .choice-row { display: grid; gap: 10px; grid-template-columns: 1fr 1fr; }
    .choice-btn { min-height: 64px; font-size: 20px; }
    .choice-btn.selected, .ring-btn.selected { outline: 3px solid var(--accent); }
    .ring-grid {
      position: relative;
      width: min(88vw, 360px);
      height: min(88vw, 360px);
      margin: 2px auto;
      display: grid;
      place-items: center;
    }
    .ring-btn {
      position: absolute;
      width: 72px;
      height: 72px;
      border-radius: 50%;
      font-size: 14px;
      font-weight: 700;
      background: #0b1220;
      border: 2px solid var(--ring);
      color: var(--fg);
    }
    .ring-center { width: 92px; height: 92px; border-radius: 50%; border: 2px dashed var(--ring); display: grid; place-items: center; color: var(--muted); font-size: 12px; }
    .summary-grid { display: grid; gap: 8px; grid-template-columns: 1fr 1fr; }
    .small { font-size: 13px; color: var(--muted); }
    #summaryCanvas { width: 100%; max-width: 720px; height: 240px; border: 1px solid var(--ring); border-radius: 12px; background: #020617; }
    @media (max-width: 420px) {
      .ring-btn { width: 64px; height: 64px; }
      .choice-btn { font-size: 18px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="pill" id="status">Ready</div>
      <div class="pill" id="stats">Level 1 · D 500ms</div>
    </div>

    <div class="controls">
      <button class="primary" id="startBtn">Start Session</button>
      <button id="practiceBtn">Practice</button>
      <button id="contrastBtn">High Contrast: Off</button>
      <button id="fullscreenBtn">Full screen hint</button>
      <button class="warn" id="resetBtn">Reset Data</button>
    </div>

    <p class="hint">Instruction: watch fixation, then identify center object (car/truck) and peripheral target location. Select both after the flash. Success = both correct.</p>

    <div class="card">
      <div id="stimulusWrap">
        <canvas id="stimulusCanvas" width="720" height="720" aria-label="Stimulus display"></canvas>
      </div>

      <div id="responsePanel" class="response hidden">
        <div class="choice-row">
          <button class="choice-btn" data-choice="car">Car</button>
          <button class="choice-btn" data-choice="truck">Truck</button>
        </div>
        <div class="ring-grid" id="ringGrid">
          <div class="ring-center">Tap location</div>
        </div>
        <button class="good" id="submitResponse" disabled>Submit Answer</button>
      </div>
    </div>

    <div class="card" style="margin-top:10px">
      <div class="summary-grid">
        <div id="liveSummary"></div>
        <div id="persistSummary" class="small"></div>
      </div>
      <canvas id="summaryCanvas" width="720" height="240" class="hidden"></canvas>
    </div>
  </div>

<script>
(() => {
  'use strict';

  const BLOCKS = 5;
  const TRIALS_PER_BLOCK = 20;
  const FIX_MS = 300;
  const MIN_D = 60;
  const MAX_D = 1200;
  const STEP = 40;

  const els = {
    body: document.body,
    status: document.getElementById('status'),
    stats: document.getElementById('stats'),
    startBtn: document.getElementById('startBtn'),
    practiceBtn: document.getElementById('practiceBtn'),
    contrastBtn: document.getElementById('contrastBtn'),
    fullscreenBtn: document.getElementById('fullscreenBtn'),
    resetBtn: document.getElementById('resetBtn'),
    canvas: document.getElementById('stimulusCanvas'),
    response: document.getElementById('responsePanel'),
    submit: document.getElementById('submitResponse'),
    liveSummary: document.getElementById('liveSummary'),
    persistSummary: document.getElementById('persistSummary'),
    summaryCanvas: document.getElementById('summaryCanvas'),
    ringGrid: document.getElementById('ringGrid')
  };
  const ctx = els.canvas.getContext('2d');

  const positions = [
    {x: 0, y: -1, label: 'N'}, {x: 0.7, y: -0.7, label: 'NE'},
    {x: 1, y: 0, label: 'E'}, {x: 0.7, y: 0.7, label: 'SE'},
    {x: 0, y: 1, label: 'S'}, {x: -0.7, y: 0.7, label: 'SW'},
    {x: -1, y: 0, label: 'W'}, {x: -0.7, y: -0.7, label: 'NW'}
  ];

  const state = {
    running: false,
    practice: false,
    block: 1,
    trial: 0,
    D: 500,
    level: 1,
    difficultyTier: 0,
    trialStartMs: 0,
    pickCenter: null,
    pickPeripheral: null,
    current: null,
    allTrials: [],
    blockStats: []
  };

  function resizeCanvas() {
    const r = els.canvas.getBoundingClientRect();
    const dpr = Math.min(window.devicePixelRatio || 1, 2);
    const size = Math.floor(Math.min(r.width, r.height) * dpr);
    if (size > 0) {
      els.canvas.width = size;
      els.canvas.height = size;
      drawIdle();
    }
  }

  function randInt(n) { return Math.floor(Math.random() * n); }
  function choose(arr) { return arr[randInt(arr.length)]; }

  function drawIdle() {
    clearCanvas();
    drawText('Ready', 0.5, 0.5, 0.06, '#94a3b8');
  }

  function clearCanvas() {
    const w = els.canvas.width, h = els.canvas.height;
    ctx.clearRect(0, 0, w, h);
    ctx.fillStyle = '#020617';
    ctx.fillRect(0, 0, w, h);
  }

  function drawText(t, xN, yN, sizeN, color) {
    const w = els.canvas.width, h = els.canvas.height;
    ctx.fillStyle = color;
    ctx.font = `${Math.floor(w * sizeN)}px -apple-system, sans-serif`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(t, w * xN, h * yN);
  }

  function drawFixation() {
    clearCanvas();
    const w = els.canvas.width, h = els.canvas.height;
    const cx = w / 2, cy = h / 2;
    const s = w * 0.04;
    ctx.strokeStyle = '#f8fafc';
    ctx.lineWidth = Math.max(2, w * 0.006);
    ctx.beginPath();
    ctx.moveTo(cx - s, cy); ctx.lineTo(cx + s, cy);
    ctx.moveTo(cx, cy - s); ctx.lineTo(cx, cy + s);
    ctx.stroke();
  }

  function drawCar(cx, cy, scale, similarity) {
    const w = scale;
    const h = scale * (0.38 + similarity * 0.04);
    ctx.fillStyle = '#60a5fa';
    ctx.fillRect(cx - w * 0.45, cy - h * 0.2, w * 0.9, h * 0.4);
    ctx.fillStyle = '#1d4ed8';
    const roofH = h * (0.33 + similarity * 0.2);
    ctx.fillRect(cx - w * 0.22, cy - h * 0.5, w * 0.44, roofH);
    ctx.fillStyle = '#111827';
    ctx.beginPath(); ctx.arc(cx - w * 0.25, cy + h * 0.26, w * 0.1, 0, Math.PI * 2); ctx.fill();
    ctx.beginPath(); ctx.arc(cx + w * 0.25, cy + h * 0.26, w * 0.1, 0, Math.PI * 2); ctx.fill();
  }

  function drawTruck(cx, cy, scale, similarity) {
    const w = scale;
    const h = scale * (0.42 - similarity * 0.04);
    ctx.fillStyle = '#f59e0b';
    ctx.fillRect(cx - w * 0.46, cy - h * 0.24, w * (0.56 + similarity * 0.15), h * 0.48);
    ctx.fillStyle = '#d97706';
    ctx.fillRect(cx + w * (0.08 + similarity * 0.07), cy - h * 0.2, w * (0.32 - similarity * 0.1), h * 0.4);
    ctx.fillStyle = '#111827';
    ctx.beginPath(); ctx.arc(cx - w * 0.22, cy + h * 0.28, w * 0.1, 0, Math.PI * 2); ctx.fill();
    ctx.beginPath(); ctx.arc(cx + w * 0.2, cy + h * 0.28, w * 0.1, 0, Math.PI * 2); ctx.fill();
  }

  function drawPeripheral(targetIdx, distractorCount) {
    const w = els.canvas.width, h = els.canvas.height;
    const cx = w / 2, cy = h / 2;
    const r = w * 0.34;
    const distractorIndices = positions.map((_, i) => i).filter(i => i !== targetIdx);
    for (let i = distractorIndices.length - 1; i > 0; i--) {
      const j = randInt(i + 1);
      [distractorIndices[i], distractorIndices[j]] = [distractorIndices[j], distractorIndices[i]];
    }
    const activeDistractors = new Set(distractorIndices.slice(0, Math.min(distractorCount, 7)));

    positions.forEach((p, i) => {
      const x = cx + p.x * r;
      const y = cy + p.y * r;
      if (i === targetIdx) {
        ctx.fillStyle = '#22c55e';
        ctx.beginPath();
        ctx.arc(x, y, w * 0.03, 0, Math.PI * 2);
        ctx.fill();
      } else if (activeDistractors.has(i)) {
        ctx.strokeStyle = '#f87171';
        ctx.lineWidth = Math.max(2, w * 0.004);
        const s = w * 0.045;
        ctx.strokeRect(x - s * 0.5, y - s * 0.5, s, s);
      }
    });
  }

  function flashStimulus(trialDef) {
    clearCanvas();
    drawPeripheral(trialDef.peripheral, trialDef.distractors);
    const w = els.canvas.width;
    const similarity = Math.min(0.9, state.difficultyTier * 0.25);
    if (trialDef.central === 'car') drawCar(w / 2, w / 2, w * 0.32, similarity);
    else drawTruck(w / 2, w / 2, w * 0.32, similarity);
  }

  function buildRingSelector() {
    positions.forEach((p, i) => {
      const b = document.createElement('button');
      b.className = 'ring-btn';
      b.textContent = p.label;
      b.dataset.idx = String(i);
      const angle = Math.atan2(p.y, p.x);
      const rr = 41;
      b.style.left = `calc(50% + ${Math.cos(angle) * rr}% - 36px)`;
      b.style.top = `calc(50% + ${Math.sin(angle) * rr}% - 36px)`;
      b.addEventListener('click', () => {
        state.pickPeripheral = i;
        [...els.ringGrid.querySelectorAll('.ring-btn')].forEach(el => el.classList.remove('selected'));
        b.classList.add('selected');
        refreshSubmit();
      });
      els.ringGrid.appendChild(b);
    });
  }

  function refreshSubmit() {
    els.submit.disabled = !(state.pickCenter && Number.isInteger(state.pickPeripheral));
  }

  function setStatus(msg) { els.status.textContent = msg; }

  function updateStatsLabel() {
    els.stats.textContent = `Level ${state.level} · D ${state.D}ms · Tier ${state.difficultyTier}`;
  }

  function getTrialDef() {
    const baseDistractors = state.practice ? 1 : 2;
    return {
      central: Math.random() < 0.5 ? 'car' : 'truck',
      peripheral: randInt(8),
      distractors: Math.min(7, baseDistractors + state.difficultyTier * 2)
    };
  }

  async function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

  function vibrate(pattern) {
    if (navigator.vibrate) navigator.vibrate(pattern);
  }

  async function runTrial() {
    state.pickCenter = null;
    state.pickPeripheral = null;
    refreshSubmit();
    [...document.querySelectorAll('.choice-btn')].forEach(b => b.classList.remove('selected'));
    [...els.ringGrid.querySelectorAll('.ring-btn')].forEach(b => b.classList.remove('selected'));

    state.current = getTrialDef();
    els.body.classList.add('trial-active');
    els.response.classList.add('hidden');

    setStatus(`Block ${state.block}/${BLOCKS} · Trial ${state.trial + 1}/${TRIALS_PER_BLOCK}`);
    drawFixation();
    await sleep(FIX_MS);

    flashStimulus(state.current);
    await sleep(state.D);

    clearCanvas();
    state.trialStartMs = performance.now();
    els.response.classList.remove('hidden');
    els.body.classList.remove('trial-active');
  }

  function evaluateAndAdvance() {
    const rt = Math.round(performance.now() - state.trialStartMs);
    const centralOk = state.pickCenter === state.current.central;
    const peripheralOk = state.pickPeripheral === state.current.peripheral;
    const success = centralOk && peripheralOk;

    state.allTrials.push({
      block: state.block,
      trial: state.trial + 1,
      D: state.D,
      level: state.level,
      tier: state.difficultyTier,
      rt,
      centralOk,
      peripheralOk,
      success
    });

    if (success) {
      if (state.D > MIN_D) {
        state.D = Math.max(MIN_D, state.D - STEP);
      } else {
        state.difficultyTier = Math.min(4, state.difficultyTier + 1);
        state.level += 1;
      }
      vibrate(10);
    } else {
      state.D = Math.min(MAX_D, state.D + STEP);
      if (state.difficultyTier > 0 && state.D > 260) {
        state.difficultyTier -= 1;
        state.level = Math.max(1, state.level - 1);
      }
      vibrate([20, 20, 20]);
    }

    updateStatsLabel();
    updateLiveSummary();

    state.trial += 1;
    if (state.trial >= TRIALS_PER_BLOCK) {
      finishBlock();
    } else {
      runTrial();
    }
  }

  function finishBlock() {
    const blockTrials = state.allTrials.filter(t => t.block === state.block);
    const acc = mean(blockTrials.map(t => t.success ? 1 : 0));
    const rt = mean(blockTrials.map(t => t.rt));
    state.blockStats.push({ block: state.block, acc, rt });

    if (state.block >= BLOCKS || state.practice) {
      endSession();
      return;
    }

    setStatus(`Break: Block ${state.block} complete. Tap Start Session to continue.`);
    els.startBtn.textContent = `Continue Block ${state.block + 1}`;
    state.block += 1;
    state.trial = 0;
    state.running = false;
  }

  function mean(arr) {
    if (!arr.length) return 0;
    return arr.reduce((a, b) => a + b, 0) / arr.length;
  }

  function updateLiveSummary() {
    const n = state.allTrials.length;
    const accC = mean(state.allTrials.map(t => t.centralOk ? 1 : 0)) * 100;
    const accP = mean(state.allTrials.map(t => t.peripheralOk ? 1 : 0)) * 100;
    const accS = mean(state.allTrials.map(t => t.success ? 1 : 0)) * 100;
    const rt = mean(state.allTrials.map(t => t.rt));

    els.liveSummary.innerHTML = `
      <strong>Session live</strong><br>
      Trials: ${n}<br>
      Central: ${accC.toFixed(1)}%<br>
      Peripheral: ${accP.toFixed(1)}%<br>
      Combined: ${accS.toFixed(1)}%<br>
      Mean RT: ${isFinite(rt) ? rt.toFixed(0) : 0}ms
    `;
  }

  function saveSession() {
    const best = Number(localStorage.getItem('dd_best_level') || 1);
    if (state.level > best) localStorage.setItem('dd_best_level', String(state.level));

    const sessions = JSON.parse(localStorage.getItem('dd_sessions') || '[]');
    const summary = {
      ts: Date.now(),
      mode: state.practice ? 'practice' : 'main',
      level: state.level,
      meanRT: Math.round(mean(state.allTrials.map(t => t.rt))),
      combinedAcc: Math.round(mean(state.allTrials.map(t => t.success ? 1 : 0)) * 100)
    };
    sessions.unshift(summary);
    localStorage.setItem('dd_sessions', JSON.stringify(sessions.slice(0, 10)));
  }

  function renderPersistence() {
    const best = Number(localStorage.getItem('dd_best_level') || 1);
    const sessions = JSON.parse(localStorage.getItem('dd_sessions') || '[]');
    const rows = sessions.map(s => {
      const d = new Date(s.ts);
      return `${d.toLocaleDateString()} ${d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}: ${s.mode}, lvl ${s.level}, acc ${s.combinedAcc}%, RT ${s.meanRT}ms`;
    }).join('<br>');

    els.persistSummary.innerHTML = `<strong>Saved</strong><br>Best level: ${best}<br>${rows || 'No sessions yet.'}`;
  }

  function drawSummaryChart() {
    const c = els.summaryCanvas;
    const g = c.getContext('2d');
    g.clearRect(0, 0, c.width, c.height);
    g.fillStyle = '#020617';
    g.fillRect(0, 0, c.width, c.height);

    const m = {l: 48, r: 12, t: 16, b: 30};
    const w = c.width - m.l - m.r;
    const h = c.height - m.t - m.b;

    g.strokeStyle = '#475569';
    g.strokeRect(m.l, m.t, w, h);

    const data = state.blockStats;
    if (!data.length) return;

    g.fillStyle = '#94a3b8';
    g.font = '12px sans-serif';
    g.fillText('Accuracy %', 6, 20);
    g.fillText('RT ms', 6, 38);

    const maxRt = Math.max(500, ...data.map(d => d.rt));

    g.strokeStyle = '#22c55e';
    g.lineWidth = 3;
    g.beginPath();
    data.forEach((d, i) => {
      const x = m.l + (i / Math.max(1, data.length - 1)) * w;
      const y = m.t + (1 - d.acc) * h;
      if (i === 0) g.moveTo(x, y); else g.lineTo(x, y);
      g.fillStyle = '#22c55e';
      g.beginPath(); g.arc(x, y, 4, 0, Math.PI * 2); g.fill();
      g.fillStyle = '#e2e8f0';
      g.fillText(`B${d.block}`, x - 10, c.height - 10);
    });
    g.stroke();

    g.strokeStyle = '#38bdf8';
    g.lineWidth = 2;
    g.beginPath();
    data.forEach((d, i) => {
      const x = m.l + (i / Math.max(1, data.length - 1)) * w;
      const y = m.t + (d.rt / maxRt) * h;
      if (i === 0) g.moveTo(x, y); else g.lineTo(x, y);
      g.fillStyle = '#38bdf8';
      g.beginPath(); g.arc(x, y, 3, 0, Math.PI * 2); g.fill();
    });
    g.stroke();
  }

  function endSession() {
    state.running = false;
    els.response.classList.add('hidden');
    clearCanvas();
    drawText('Session Complete', 0.5, 0.48, 0.06, '#f8fafc');
    drawText('See summary below', 0.5, 0.56, 0.035, '#94a3b8');

    saveSession();
    renderPersistence();
    drawSummaryChart();
    els.summaryCanvas.classList.remove('hidden');

    const c = mean(state.allTrials.map(t => t.centralOk ? 1 : 0)) * 100;
    const p = mean(state.allTrials.map(t => t.peripheralOk ? 1 : 0)) * 100;
    const s = mean(state.allTrials.map(t => t.success ? 1 : 0)) * 100;
    const rt = mean(state.allTrials.map(t => t.rt));

    setStatus(`Done · Central ${c.toFixed(1)}% · Peripheral ${p.toFixed(1)}% · Combined ${s.toFixed(1)}% · RT ${rt.toFixed(0)}ms`);
    els.startBtn.textContent = 'Start Session';
  }

  function start(modePractice) {
    if (state.running) return;
    if (!state.allTrials.length || (!modePractice && state.block === 1 && state.trial === 0)) {
      state.practice = modePractice;
      state.block = 1;
      state.trial = 0;
      state.level = 1;
      state.difficultyTier = 0;
      state.D = modePractice ? 900 : 500;
      state.allTrials = [];
      state.blockStats = [];
      updateLiveSummary();
      els.summaryCanvas.classList.add('hidden');
    }

    state.running = true;
    setStatus(modePractice ? 'Practice mode' : `Block ${state.block}/${BLOCKS}`);
    updateStatsLabel();
    runTrial();
  }

  function onCenterChoice(e) {
    const b = e.target.closest('.choice-btn');
    if (!b) return;
    state.pickCenter = b.dataset.choice;
    [...document.querySelectorAll('.choice-btn')].forEach(el => el.classList.remove('selected'));
    b.classList.add('selected');
    refreshSubmit();
  }

  function resetData() {
    localStorage.removeItem('dd_best_level');
    localStorage.removeItem('dd_sessions');
    renderPersistence();
    setStatus('Saved data reset.');
  }

  function setup() {
    buildRingSelector();

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    document.addEventListener('touchmove', (e) => {
      if (document.body.classList.contains('trial-active')) e.preventDefault();
    }, { passive: false });

    document.addEventListener('gesturestart', (e) => e.preventDefault());
    document.addEventListener('dblclick', (e) => e.preventDefault(), { passive: false });

    els.startBtn.addEventListener('click', () => start(false));
    els.practiceBtn.addEventListener('click', () => {
      state.block = 1;
      state.trial = 0;
      state.allTrials = [];
      state.blockStats = [];
      start(true);
    });

    document.querySelector('.choice-row').addEventListener('click', onCenterChoice);
    els.submit.addEventListener('click', evaluateAndAdvance);

    els.contrastBtn.addEventListener('click', () => {
      const on = els.body.classList.toggle('high-contrast');
      els.contrastBtn.textContent = `High Contrast: ${on ? 'On' : 'Off'}`;
      resizeCanvas();
    });

    els.fullscreenBtn.addEventListener('click', async () => {
      setStatus('Tip: Add to Home Screen for full-screen-like play on iPhone.');
      if (document.documentElement.requestFullscreen) {
        try { await document.documentElement.requestFullscreen(); } catch (_) {}
      }
    });

    els.resetBtn.addEventListener('click', resetData);

    renderPersistence();
    updateLiveSummary();
    updateStatsLabel();
  }

  setup();
})();
</script>
</body>
</html>
